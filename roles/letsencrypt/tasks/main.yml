---
- name: install letsencrypt client
  pacman: name=letsencrypt state=present
  tags: [install]

- name: create a webroot for letsencrypt
  file:
    path: "{{ letsencrypt_webroot }}"
    state: directory
    owner: http
    group: http
    mode: 0750
    recurse: yes
  tags: [install]

- name: configure letsencrypt
  template:
    src: cli.ini.j2
    dest: /etc/letsencrypt/cli.ini

- name: enable services http and https in firewalld
  firewalld: service={{ item }} state=enabled permanent=yes immediate=yes
  with_items: [http, https]
  tags: [serve]

- name: create service unit file for certificate renewal
  copy:
    src: letsencrypt-renew.service
    dest: /etc/systemd/system/letsencrypt-renew.service
  notify: reload systemd
  tags: [install]

- name: create timer unit file for certificate renewal
  copy:
    src: letsencrypt-renew.timer
    dest: /etc/systemd/system/letsencrypt-renew.timer
  notify:
  - reload systemd
  - restart letsencrypt-renew.timer
  tags: [install]

- name: start and enable letsencrypt-renew.timer
  service: name=letsencrypt-renew.timer state=started enabled=true
  tags: [serve]

#- name: request SSL certificates
#  command: letsencrypt --staging certonly
#  tags: [serve]
