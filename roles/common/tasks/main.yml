---
- name: remove unused repositories
  apt_repository:
    repo: "{{ item }}"
    state: absent
  with_items:
  - deb-src http://debian.mirror.iweb.ca/debian/ jessie main
  - deb-src http://security.debian.org/ jessie/updates main
  - deb-src http://debian.mirror.iweb.ca/debian/ jessie-updates main
  tags: [configure]

- name: install packages
  apt: name={{ item }} state=present
  with_items:
  - firewalld
  - vim
  - sudo
  - tmux
  - git
  - sysstat
  - haveged
  - rsync
  - strace
  #- sysdig
  #- linux-headers
  tags: [install]

- name: install networking tools
  apt: name={{ item }} state=present
  with_items:
    - mtr
    - ethtool
    - net-tools
    - nmap
    - iperf
    - dnstracer
    - tcpdump
    - ipcalc
  tags: [install]

- name: start and enable services
  service: name={{ item }} state=started enabled=yes
  with_items:
  - sysstat
  - haveged
  - firewalld
  tags: [serve]

- name: create /var/log/lastlog
  file:
    path: /var/log/lastlog
    state: touch
    group: utmp
    mode: 0644
  tags: [configure]

# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=717217
- name: fix UDP checksum error
  command: firewall-cmd {{ item }} --direct --add-rule ipv4 mangle POSTROUTING 0 -p udp --dport bootps -j CHECKSUM --checksum-fill
  register: direct
  changed_when: '"ALREADY_ENABLED" not in direct.stdout'
  with_items: ["", --permanent]
  tags: [serve]

- name: Configure exim4
  copy:
    src: update-exim4.conf.conf
    dest: /etc/exim4/update-exim4.conf.conf
  notify:
  - update exim4 configuration
  - restart exim4
  tags: [configure]
