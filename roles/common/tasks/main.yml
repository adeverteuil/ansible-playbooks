---
- name: remove or add source package repositories
  apt_repository:
    repo: "{{ item }}"
    state: "{{ common_deb_src_repos }}"
    mode: 0644
  with_items:
  - deb-src http://debian.mirror.iweb.ca/debian/ jessie main
  - deb-src http://security.debian.org/ jessie/updates main
  - deb-src http://debian.mirror.iweb.ca/debian/ jessie-updates main
  tags: [configure]

- name: install packages
  apt: name={{ item }} state=present
  with_items:
  - firewalld
  - vim
  - sudo
  - tmux
  - git
  - sysstat
  - haveged
  - rsync
  - strace
  #- sysdig
  #- linux-headers
  tags: [install]

- name: install networking tools
  apt: name={{ item }} state=present
  with_items:
    - mtr
    - ethtool
    - net-tools
    - nmap
    - iperf
    - dnstracer
    - tcpdump
    - ipcalc
  tags: [install]

- name: start and enable services
  service: name={{ item }} state=started enabled=yes
  with_items:
  - sysstat
  - haveged
  - firewalld
  tags: [serve]

- name: create /var/log/lastlog
  # I don't want to touch it if it already exists
  # so I use the command rather than the file module.
  # Using copy scans terabytes of sparse zeroes for
  # comparison with an empty content.
  command: touch /var/log/lastlog
  args:
    creates: /var/log/lastlog
  tags: [configure]

- name: ensure proper permissions and ownership for lastlog
  file:
    path: /var/log/lastlog
    state: file
    group: utmp
    mode: 0644
  tags: [configure]

# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=717217
- name: fix UDP checksum error
  command: firewall-cmd {{ item }} --direct --add-rule ipv4 mangle POSTROUTING 0 -p udp --dport bootps -j CHECKSUM --checksum-fill
  register: direct
  changed_when: '"ALREADY_ENABLED" not in direct.stdout'
  with_items: ["", --permanent]
  tags: [serve]

- name: configure exim4
  template:
    src: update-exim4.conf.conf.j2
    dest: /etc/exim4/update-exim4.conf.conf
  notify:
  - update exim4 configuration
  - restart exim4
  tags: [configure]

- name: set email to send root mail to
  lineinfile:
    dest: /etc/aliases
    line: "root: {{ exim_root_alias }}"
    regexp: ^root

- name: generate locales
  lineinfile:
    dest: /etc/locale.gen
    line: "{{ item }}"
    regexp: ^[# ]*{{ item }}
  with_items:
  - en_CA.UTF-8 UTF-8
  - en_DK.UTF-8 UTF-8
  - en_US.UTF-8 UTF-8
  - fr_CA.UTF-8 UTF-8
  notify: run locale-gen
  tags: [configure]
