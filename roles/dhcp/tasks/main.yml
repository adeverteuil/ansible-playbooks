---
- name: install dhcp
  apt: name=isc-dhcp-server state=present
  tags: [install]

- name: configure dhcp
  template:
    src: dhcpd.conf.j2
    dest: /etc/dhcp/dhcpd.conf
  notify: restart dhcpd
  tags: [configure]

- name: start and enable dhcpd
  service: name=isc-dhcp-server state=started enabled=yes
  tags: [serve]

- name: let dhcp through the firewall
  firewalld: service=dhcp state=enabled permanent=yes immediate=yes
  tags: [serve]

# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=717217
- name: fix UDP checksum error
  command: firewall-cmd {{ item }} --direct --add-rule ipv4 mangle POSTROUTING 0 -p udp --dport bootpc -j CHECKSUM --checksum-fill
  register: direct
  changed_when: '"ALREADY_ENABLED" not in direct.stdout'
  with_items: ["", --permanent]
  tags: [serve]
