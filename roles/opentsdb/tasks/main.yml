---
- name: install requirements
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - gnuplot-nox

- name: install opentsdb
  apt:
    deb: https://github.com/OpenTSDB/opentsdb/releases/download/v2.3.0/opentsdb-2.3.0_all.deb
    state: present

- name: configure opentsdb
  template:
    src: opentsdb.conf.j2
    dest: /etc/opentsdb/opentsdb.conf
  notify: restart opentsdb

- name: create the opentsdb.service.d directory
  file:
    dest: /etc/systemd/system/opentsdb.service.d
    state: directory

- name: override some opentsdb.service directives
  copy:
    src: opentsdb.pidfile.conf
    dest: /etc/systemd/system/opentsdb.service.d/opentsdb.pidfile.conf

- name: start and enable opentsdb
  systemd:
    daemon_reload: yes
    name: opentsdb
    state: started
    enabled: yes

- name: open port 4242
  firewalld:
    port: 4242/tcp
    state: enabled
    permanent: yes
    immediate: yes
