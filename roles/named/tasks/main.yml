---
- name: install bind9 and bind9-doc
  apt: name={{ item }} state=present
  with_items: [bind9, bind9-doc]
  tags: [install]

- name: write the rndc key file
  template:
    src: rndc.key.j2
    dest: /etc/bind/rndc.key
    mode: 0640
    owner: bind
    group: bind
  notify: reload bind
  tags: [configure]

- name: configure bind
  template:
    src: named.conf{{ item }}.j2
    dest: /etc/bind/named.conf{{ item }}
    mode: 0640
    owner: root
    group: bind
  with_items: ["", .options, .local]
  notify: reload bind
  tags: [configure]

- name: install minimal localdomain zone file
  template:
    src: localdomain.db.j2
    dest: /var/lib/bind/{{ bind_localdomain }}.db
    force: no
  when: named_master
  notify: reload bind
  tags: [install]

- name: install minimal localdomain rDNS zone file
  template:
    src: rdns.db.j2
    dest: /var/lib/bind/13.168.192.in-addr.arpa.db
    force: no
  when: named_master
  notify: reload bind
  tags: [install]

- name: create a directory to extend bind9.service
  file:
    path: /etc/systemd/system/bind9.service.d
    state: directory
  tags: [configure]

- name: start bind9 with ipv4 support only
  file:
    src: ipv4.conf
    dest: /etc/systemd/system/bind9.service.d/ipv4.conf
  notify:
  - reload systemd
  - restart bind9
  tags: [configure]

- name: start and enable bind
  service: name=bind9 state=started enabled=yes
  tags: [serve]

- name: enable DNS service in firewalld
  firewalld: service=dns state=enabled permanent=yes immediate=yes
  tags: [serve]
