---
- name: install dovecot
  pacman: name=dovecot state=present
  tags: [install]

- name: configure dovecot general options
  template:
    src: dovecot.conf.j2
    dest: /etc/dovecot/dovecot.conf
  notify: restart dovecot
  tags: [configure]

- name: configure dovecot specific options
  template:
    src: "{{ item }}.j2"
    dest: /etc/dovecot/conf.d/{{ item }}
  with_items:
    - 10-auth.conf
    - 10-mail.conf
    - 10-ssl.conf
  notify: restart dovecot
  tags: [configure]

- name: configure dovecot pam module
  template:
    src: pam_dovecot.j2
    dest: /etc/pam.d/dovecot
  notify: restart dovecot
  tags: [configure]

- include: ipa.yml

- name: configure SSL certificate
  template:
    src: dovecot-openssl.cnf.j2
    dest: /etc/ssl/dovecot-openssl.cnf
  notify: make dovecot SSL certificate
  tags: [configure]

- name: enable services in firewalld
  firewalld: service={{ item }} state=enabled permanent=yes immediate=yes
  with_items: [imap, imaps, pop3, pop3s]
  tags: [serve]

- name: start and enable dovecot
  service: name=dovecot state=started enabled=yes
  tags: [serve]
